<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <title>Cycloneoi Hub – Pacifique Ouest (ECMWF)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="./style.css" />
  </head>
  <body>
    <header class="coi-header">
      <div class="coi-header-inner">
        <h1>Cycloneoi Hub – Pacifique Ouest</h1>
        <p class="subtitle">
          Diagrams ECMWF · Strike probability &amp; Plumes · Mise à jour auto
          toutes les 6&nbsp;h
        </p>
      </div>
    </header>

    <main class="coi-main">
      <section class="coi-panel">
        <div id="status" class="status">Chargement des données…</div>

        <!-- Onglets systèmes -->
        <div id="tabs" class="systems-tabs"></div>

        <!-- Vue système sélectionné -->
        <div id="system-view" class="system-view"></div>
      </section>
    </main>

    <footer class="coi-footer">
      <p>
        Données de prévision : ECMWF · Intégration automatique par Cycloneoi.
      </p>
    </footer>

    <script>
      async function loadEcmwfWpac() {
        const statusEl = document.getElementById("status");
        const tabsEl = document.getElementById("tabs");
        const viewEl = document.getElementById("system-view");

        try {
          const res = await fetch("./data/ecmwf-wpac.json?c=" + Date.now());
          if (!res.ok) throw new Error("HTTP " + res.status);
          const data = await res.json();

          statusEl.textContent =
            "Dernière mise à jour : " + (data.lastUpdate || "n/a");

          const systems = Array.isArray(data.systems) ? data.systems : [];
          if (!systems.length) {
            tabsEl.innerHTML = "";
            viewEl.innerHTML =
              '<div class="empty">Aucune activité en cours dans le Pacifique Ouest.</div>';
            return;
          }

          let activeIndex = 0;

          function renderTabs() {
            tabsEl.innerHTML = systems
              .map(
                (sys, index) => `
                  <button
                    class="system-tab ${index === activeIndex ? "is-active" : ""}"
                    data-index="${index}"
                  >
                    <span class="tab-id">${sys.id || "??"}</span>
                    <span class="tab-name">${sys.name || ""}</span>
                  </button>
                `
              )
              .join("");

            tabsEl.querySelectorAll(".system-tab").forEach((btn) => {
              btn.addEventListener("click", () => {
                const idx = Number(btn.getAttribute("data-index"));
                if (!Number.isNaN(idx) && idx !== activeIndex) {
                  activeIndex = idx;
                  renderTabs();
                  renderSystem();
                }
              });
            });
          }

          function renderSystem() {
            const sys = systems[activeIndex];
            if (!sys) return;

            const strikeImg = sys.strikeImage || null;
            const plumesImg = sys.plumesImage || null;

            const runInfo =
              sys.advisoryTime ||
              sys.run ||
              (sys.year ? String(sys.year) : "Prévision en cours");

            viewEl.innerHTML = `
              <article class="tc-card">
                <header class="tc-card-header">
                  <div class="tc-title">
                    <span class="tc-id">${sys.id || ""}</span>
                    <span class="tc-name">${sys.name || ""}</span>
                  </div>
                  <div class="tc-meta">
                    Bassin&nbsp;: ${sys.basin || "WPAC"}
                    · Centre&nbsp;: ${sys.center || "ECMWF"}
                    ${sys.year ? " · Année&nbsp;: " + sys.year : ""}
                    ${runInfo ? " · Run&nbsp;: " + runInfo : ""}
                  </div>
                </header>

                <div class="tc-card-body">
                  <div class="tc-column">
                    <h2>Strike probability (ECMWF)</h2>
                    ${
                      strikeImg
                        ? `
                          <a href="${strikeImg}" target="_blank" rel="noopener noreferrer">
                            <img
                              src="${strikeImg}"
                              alt="Strike probability · ${sys.name || sys.id || ""}"
                              class="tc-image"
                              loading="lazy"
                            />
                          </a>
                        `
                        : `<p class="tc-missing">Image Strike non disponible.</p>`
                    }
                  </div>

                  <div class="tc-column">
                    <h2>Plumes (ECMWF)</h2>
                    ${
                      plumesImg
                        ? `
                          <a href="${plumesImg}" target="_blank" rel="noopener noreferrer">
                            <img
                              src="${plumesImg}"
                              alt="Plumes · ${sys.name || sys.id || ""}"
                              class="tc-image"
                              loading="lazy"
                            />
                          </a>
                        `
                        : `<p class="tc-missing">Image Plumes non disponible.</p>`
                    }
                  </div>
                </div>

                <div class="tc-links-row">
                  ${
                    sys.strikePage
                      ? `<a class="tc-link" href="${sys.strikePage}" target="_blank" rel="noopener noreferrer">
                           Page interactive Strike ECMWF
                         </a>`
                      : ""
                  }
                  ${
                    sys.plumesPage
                      ? `<a class="tc-link" href="${sys.plumesPage}" target="_blank" rel="noopener noreferrer">
                           Page interactive Plumes ECMWF
                         </a>`
                      : ""
                  }
                </div>
              </article>
            `;
          }

          renderTabs();
          renderSystem();
        } catch (err) {
          console.error(err);
          statusEl.textContent = "Erreur de chargement des données.";
          document.getElementById("tabs").innerHTML = "";
          document.getElementById("system-view").innerHTML =
            '<div class="empty error">Impossible de charger les données pour le moment.</div>';
        }
      }

      loadEcmwfWpac();
    </script>
  </body>
</html>

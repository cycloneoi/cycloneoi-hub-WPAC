<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <title>Cycloneoi Hub – Pacifique Ouest (ECMWF)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="./style.css" />
  </head>

  <body>
    <!-- ===== HEADER ===== -->
    <header class="coi-header">
      <div class="coi-header-inner">
        <h1>Cycloneoi Hub – Pacifique Ouest</h1>
        <p class="subtitle">
          Diagrams ECMWF · Strike probability &amp; Plumes · Mise à jour auto
          toutes les 6&nbsp;h
        </p>
      </div>
    </header>

    <!-- ===== MAIN ===== -->
    <main class="coi-main">
      <section class="coi-panel">
        <div id="status" class="status">Chargement des données…</div>
        <div id="systems" class="systems-grid"></div>
      </section>
    </main>

    <!-- ===== FOOTER ===== -->
    <footer class="coi-footer">
      <p>
        Données de prévision : ECMWF · Intégration automatique par Cycloneoi.
      </p>
    </footer>

    <!-- ===== SCRIPT PRINCIPAL ===== -->
    <script>
      // Convertit une URL "produit" ECMWF (page HTML)
      // en URL PNG via l'API opencharts
      function toPngUrl(pageUrl) {
        if (!pageUrl) return null;
        try {
          const u = new URL(pageUrl);

          const base_time = u.searchParams.get("base_time");
          const offset = u.searchParams.get("offset");
          const product = u.searchParams.get("product");
          const unique_id = u.searchParams.get("unique_id");

          if (!base_time || !product) return null;

          const api = new URL(
            "https://charts.ecmwf.int/opencharts-api/v1/products/cyclone/"
          );
          api.searchParams.set("format", "png");
          api.searchParams.set("base_time", base_time);
          api.searchParams.set("product", product);
          if (offset) api.searchParams.set("offset", offset);
          if (unique_id) api.searchParams.set("unique_id", unique_id);

          return api.toString();
        } catch (e) {
          console.error("toPngUrl error:", e);
          return null;
        }
      }

      async function loadCatalog() {
        const statusEl = document.getElementById("status");
        const systemsEl = document.getElementById("systems");

        try {
          // IMPORTANT : on lit maintenant ecmwf-wpac.json
          const res = await fetch("./data/ecmwf-wpac.json?c=" + Date.now());
          if (!res.ok) throw new Error("HTTP " + res.status);

          const catalog = await res.json();
          const systems = catalog.systems || [];

          statusEl.textContent =
            "Dernière mise à jour : " + (catalog.lastUpdate || "n/a");

          if (!systems.length) {
            systemsEl.innerHTML =
              '<div class="empty">Aucune activité en cours dans le Pacifique Ouest.</div>';
            return;
          }

          systemsEl.innerHTML = "";

          systems.forEach((sys) => {
            const card = document.createElement("article");
            card.className = "tc-card";

            const strikePng = toPngUrl(sys.strikeUrl);
            const plumesPng = toPngUrl(sys.plumesUrl);

            card.innerHTML = `
              <h2 class="tc-name">${sys.id} · ${sys.name}</h2>
              <p class="tc-meta">
                Bassin&nbsp;: ${sys.basin || "WPAC"}
                · Centre&nbsp;: ${sys.center || "ECMWF"}
                · Année&nbsp;: ${sys.year || "—"}
                ${
                  sys.advisoryTime
                    ? " · Run&nbsp;: " + sys.advisoryTime
                    : ""
                }
              </p>

              <div class="tc-links">
                ${
                  sys.strikeUrl
                    ? `<a class="tc-link" href="${sys.strikeUrl}" target="_blank" rel="noopener noreferrer">
                         Ouvrir la page Strike ECMWF
                       </a>`
                    : ""
                }
                ${
                  sys.plumesUrl
                    ? `<a class="tc-link" href="${sys.plumesUrl}" target="_blank" rel="noopener noreferrer">
                         Ouvrir la page Plumes ECMWF
                       </a>`
                    : ""
                }
              </div>

              <div class="tc-images">
                ${
                  strikePng
                    ? `<div class="tc-image-block">
                         <h3>Strike probability (ECMWF)</h3>
                         <img src="${strikePng}" alt="Strike probability">
                       </div>`
                    : ""
                }

                ${
                  plumesPng
                    ? `<div class="tc-image-block">
                         <h3>Plumes (ECMWF)</h3>
                         <img src="${plumesPng}" alt="Plumes ECMWF">
                       </div>`
                    : ""
                }
              </div>
            `;

            systemsEl.appendChild(card);
          });
        } catch (err) {
          console.error(err);
          statusEl.textContent = "Erreur de chargement du catalogue.";
          systemsEl.innerHTML =
            '<div class="empty error">Impossible de charger les données pour le moment.</div>';
        }
      }

      loadCatalog();
    </script>
  </body>
</html>
